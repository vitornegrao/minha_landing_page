#!/bin/bash

# Define o diretÃ³rio base do projeto
project_dir=$(git rev-parse --show-toplevel)
cd "$project_dir" || exit

echo "ğŸ”„ AlteraÃ§Ãµes detectadas. Iniciando automaÃ§Ã£o pÃ³s-merge..."

# --- 1. InstalaÃ§Ã£o de DependÃªncias ---
# Verifica se houve alteraÃ§Ã£o no package-lock.json para decidir se roda npm install
# Usamos 'npm ci' (Clean Install) que Ã© mais rÃ¡pido e seguro para produÃ§Ã£o
if git diff-tree -r --name-only --no-commit-id HEAD@{1} HEAD | grep --quiet 'package-lock.json'; then
    echo "ğŸ“¦ MudanÃ§as nas dependÃªncias detectadas. Executando npm ci..."
    npm ci
fi

# --- 2. Build da AplicaÃ§Ã£o ---
echo "ğŸš€ Executando npm run build..."
npm run build

# --- 3. CorreÃ§Ã£o de PermissÃµes (CrÃ­tico para seu ambiente) ---
# Como vocÃª pode estar rodando git pull como root, o build serÃ¡ criado como root.
# Isso devolve a propriedade para o usuÃ¡rio do servidor web (www-data).
echo "ğŸ”’ Ajustando permissÃµes da pasta dist para www-data..."
chown -R www-data:www-data "$project_dir/dist"

echo "âœ… Build finalizado e permissÃµes ajustadas!"